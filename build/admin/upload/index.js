!function(){"use strict";var e,t={795:function(){const{View:e}=Backbone;var t=class extends e{get className(){return"image-watermark media-button button button-large"}get tagName(){return"button"}get template(){return"Add watermark"}initialize(){return this.render(),this}render(){return this.$el.html(this.template),this}};const i=wp.api.WPApiBaseModel.extend({url:wpApiSettings.root+"wp/v2/settings"}),s={center:{value:15,translate:(e,t)=>[e[0]/2-t[0]/2,e[1]/2-t[1]/2]},top:{value:1,translate:(e,t)=>[e[0]/2-t[0]/2,0]},bottom:{value:2,translate:(e,t)=>[e[0]/2-t[0]/2,e[1]-t[1]]},right:{value:4,translate:(e,t)=>[e[0]-t[0],e[1]/2-t[1]/2]},left:{value:8,translate:(e,t)=>[0,e[1]/2-t[1]/2]},topRight:{value:5,translate:(e,t)=>[e[0]-t[0],0]},bottomRight:{value:6,translate:(e,t)=>[e[0]-t[0],e[1]-t[1]]},topLeft:{value:9,translate:(e,t)=>[0,0]},bottomLeft:{value:10,translate:(e,t)=>[0,e[1]-t[1]]}},n=e=>{const t=new Image;return t.src=e,new Promise((e=>{t.onload=()=>{e(t)}})).then((e=>e))},r=async(e,t)=>{const{image:r,position:a}=await(async()=>{const{image_watermark_settings:e}=await(async()=>{const e=new i;return await e.fetch({headers:{"X-WP-Nonce":wpApiSettings.nonce}}).then((t=>{e.set(t)})),e.attributes})(),{image_id:t,position:s}=e;return(n=t,new wp.api.models.Media({id:n}).fetch()).then((e=>{const{thumbnail:t}=e.media_details.sizes;return{image:{url:t.source_url,height:t.height,width:t.width},position:Number(s)}}));var n})(),l=await(async(e,t,i,r,a,l)=>{const o=await(async(e,t,i,r,a)=>{const l=document.createElement("canvas"),o=await n(e),h=await n(t),c=((e,t,i)=>{const n=Object.keys(s).find((t=>s[t].value===e));return n&&s[n].translate?s[n].translate(t,i):[0,0]})(a,i,r),d=l.getContext("2d");return l.width=i[0],l.height=i[1],d.drawImage(o,0,0,i[0],i[1]),d.drawImage(h,c[0],c[1],r[0],r[1]),l})(e,t,i,r,a);return new Promise((e=>{o.toBlob((async t=>{e(t)}),`image/${l}`)})).then((e=>e))})(e.url,r.url,[e.width,e.height],[r.width,r.height],a,t);return((e,t,i)=>fetch(wp.api.utils.getRootUrl()+"/wp-json/wp/v2/media",{method:"POST",headers:{"X-WP-Nonce":wpApiSettings.nonce,"Content-Disposition":`attachment; filename="${t}.${i}"`,"Content-type":`image/${i}`},body:e}).then((e=>201===e.status&&e.json())).catch((e=>console.error(e))))(l,`${e.title} (marked)`,t)},{Events:a}=Backbone;class l extends(_.extend(t,a)){get events(){return{click:"click"}}isSingle=!0;constructor(e){super(e),e&&(e.selection&&(this.selection=e.selection),(e.isSingle||!1===e.isSingle)&&(this.isSingle=e.isSingle)),this.bind("loadingStart",null,this),this.bind("loadingEnd",null,this),this.bind("saveResult",null,this)}async click(){if(this.selection){this.trigger("loadingStart");const e=await(this.isSingle?this._generateSingleImage():this._generateMultipleImages());this.trigger("saveResult",e),this.trigger("loadingEnd")}}async _generateSingleImage(){const{attributes:e}=this.selection;return r({url:e.url,height:e.height,width:e.width,title:e.title},"png")}async _generateMultipleImages(){const e=this.selection.models.map((e=>{let{attributes:t}=e;return r({url:t.url,title:t.title,height:t.height,width:t.width},"png")}));return Promise.all(e,(e=>e))}}var o=l;const{View:h}=Backbone;var c=class extends h{get className(){return"loader"}get tagName(){return"span"}get template(){return'<div class="loader__spinner"></div>'}initialize(){return this.render(),this}render(){return this.$el.html(this.template),this}};const{Events:d}=Backbone;class u extends(_.extend(c,d)){_activeClassName="loader--active";constructor(e){super(e),this.bind("show",this._show,this),this.bind("hide",this._hide,this)}_show(){this.el.classList.add(this._activeClassName)}_hide(){this.el.classList.remove(this._activeClassName)}}var g=u,m=class extends o{initialize(e){this._loaderView=new g,super.initialize(e),this.on("loadingStart",(()=>{this._loaderView.trigger("show")})),this.on("loadingEnd",(()=>{this._loaderView.trigger("hide")})),this.on("saveResult",(e=>{this._showResult(e)}))}render(){return super.render(),this.el.append(this._loaderView.el),this}_showResult(e){e?this.isSingle?this._showSingleResult(e):this._showMultipleResult(e):alert("Encountered some issues. Image has not been created.")}_showSingleResult(e){confirm("New image created. See new image.")&&window.open(e.source_url,"_blank")}_showMultipleResult(e){if(0===e.length)alert("no image selected");else{const t=e.filter((e=>e));alert(`${t.length} / ${e.length} images added.`)}this.selection.reset()}},p=class extends m{get className(){return super.className+" button-primary hidden"}constructor(e){super(e),this.isSingle=!1,this.controller=e.controller,this.controller.on("select:activate",(()=>{this._show(),0===this.selection.length&&this._disable(),this.controller.on("selection:toggle",(()=>{0===this.selection.length?this._disable():this._isDisabled()&&this._enable()})),this.controller.on("select:deactivate",(()=>{this._hide()})),this.selection.on("reset",(e=>{this._disable()}))}))}_hide(){this.el.classList.add("hidden")}_show(){this.el.classList.remove("hidden")}_isDisabled(){return this.el.classList.contains("disabled")}_disable(){this.el.classList.add("disabled")}_enable(){this.el.classList.remove("disabled")}};const{Toolbar:w}=wp.media.view;const{View:v}=Backbone;var b=class extends v{get tagName(){return"span"}get className(){return"watermark-settings setting"}get template(){return'<label class="name">Watermark</label>'}initialize(e){let{model:t}=e;return this._watermarkButton=new m({selection:t}),this.render(),this}render(){return this.$el.html(this.template),this.el.append(this._watermarkButton.el),this}};const{TwoColumn:f}=wp.media.view.Attachment.Details;wp.media.view.Attachment.Details.TwoColumn=f.extend({initialize(){return f.prototype.initialize.apply(this),this._watermarkSettingsView=new b({model:this.model}),this},render(){return f.prototype.render.apply(this),this.el.querySelector(".settings").prepend(this._watermarkSettingsView.el),this}}),wp.media.view.Toolbar=w.extend({initialize(){w.prototype.initialize.apply(this);const{controller:e,selection:t}=this;this._watermarkButtonView=new p({controller:e,selection:t})},render(){return w.prototype.render.apply(this),this.controller.on("uploader:ready",(()=>{this.el.querySelector(".media-toolbar-secondary").prepend(this._watermarkButtonView.el)})),this}})}},i={};function s(e){var n=i[e];if(void 0!==n)return n.exports;var r=i[e]={exports:{}};return t[e](r,r.exports,s),r.exports}s.m=t,e=[],s.O=function(t,i,n,r){if(!i){var a=1/0;for(c=0;c<e.length;c++){i=e[c][0],n=e[c][1],r=e[c][2];for(var l=!0,o=0;o<i.length;o++)(!1&r||a>=r)&&Object.keys(s.O).every((function(e){return s.O[e](i[o])}))?i.splice(o--,1):(l=!1,r<a&&(a=r));if(l){e.splice(c--,1);var h=n();void 0!==h&&(t=h)}}return t}r=r||0;for(var c=e.length;c>0&&e[c-1][2]>r;c--)e[c]=e[c-1];e[c]=[i,n,r]},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},function(){var e={59:0,35:0};s.O.j=function(t){return 0===e[t]};var t=function(t,i){var n,r,a=i[0],l=i[1],o=i[2],h=0;if(a.some((function(t){return 0!==e[t]}))){for(n in l)s.o(l,n)&&(s.m[n]=l[n]);if(o)var c=o(s)}for(t&&t(i);h<a.length;h++)r=a[h],s.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return s.O(c)},i=self.webpackChunkwordpress_plugin_image_watermark=self.webpackChunkwordpress_plugin_image_watermark||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))}();var n=s.O(void 0,[35],(function(){return s(795)}));n=s.O(n)}();